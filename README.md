# Watchman Opt-Out Upload

A Bun toolset for interacting with the Watchman API, including opt-out record uploads and term management.

## Setup

1. Install dependencies:
   ```bash
   bun install
   ```

2. Create environment configuration:
   ```bash
   cp .env.example .env
   ```

3. Edit `.env` with your API credentials:
   ```
   WATCHMAN_API_BASE_URL=https://stagingapi.watchmanpaymentsystems.com/wps/rest/
   WATCHMAN_API_KEY=your_api_key_here
   WATCHMAN_API_SECRET=your_api_secret_here
   ```

## Available Tasks

### wps:status
Check the Watchman Cart API status.

```bash
bun run wps:status
```

### wps:terms
List all terms from the Watchman Billing API.

```bash
bun run wps:terms
```

### wps:terms:map
Fetch terms from the API and update `data/term-code-mapping.json` with the current term codes.

```bash
bun run wps:terms:map
```

### wps:adoptions
Fetch adoptions for a specific term from the Watchman Billing API.

```bash
bun run wps:adoptions <term-code>
```

### wps:adopt
Bulk upload adoptions from a booklist CSV to the Watchman Billing API. The term code is required since the booklist CSV does not contain term information. The CSV path defaults to `data/full-booklist.csv`.

```bash
bun run wps:adopt <term-code> [csv-path]
```

Example:
```bash
bun run wps:adopt 2026SP data/full-booklist.csv
```

### wps:upload
Upload opt-out records from a CSV file to the Watchman API.

Before each opt-out is posted:
- **Adoption check**: Verifies the adoption exists at WPS for the course+ISBN. If missing, creates it automatically.
- **Enrollment check**: Verifies the student is enrolled at WPS for the course. If missing, logs a debug message (does not block the opt-out).

```bash
bun run wps:upload <csv-file-path>
```

Example:
```bash
bun run wps:upload data/opt-outs.csv
```

## CSV Format

The input CSV must have the following columns:

| Column | Description |
|--------|-------------|
| Date Sent | Date the opt-out was sent |
| term | Academic term (e.g., "Spring 2026") |
| crn | Course Reference Number |
| courseandsectioncode | Course and section (e.g., "SW-685-MOL2") |
| studentid | Student identifier |
| firstname | Student first name |
| lastname | Student last name |
| email | Student email |
| ISBN | Book ISBN |
| title | Book title |
| author | Book author |
| publisher | Publisher name |
| startdate | Course start date |
| censusdate | Census date |
| enddate | Course end date |
| coursetitle | Course title |
| coursecode | Course code |
| enrollmentstatus | Enrollment status |
| optout | Opt-out status ("Opted out" or "TRUE") |
| contenttype | Content type ("eBook" or "Courseware") |

## Logging

Logs are written to the `logs/` directory with timestamps. Each run creates a new log file:
```
logs/opt-out-2026-01-29T12-30-45-123Z.log
```

## Data Files

The `data/` directory is gitignored and used for local data files:

- `data/term-code-mapping.json` — Generated by `wps:terms:map`, maps CSV term names to API codes
- `data/full-booklist.csv` — Booklist downloaded from the [Admin tool](https://admin.bibliu.com), used by `wps:adopt`
- `data/opt-outs.csv` — Opt-out records for upload

## Processing

- Records are processed one at a time
- Before each opt-out, the adoption is verified (and created if missing) and the student enrollment is checked
- On 401 errors, the token is automatically refreshed and the request retried
- Other errors are logged and processing continues to the next record
- A summary is printed at completion showing success/failure/skipped counts
